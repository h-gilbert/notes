name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        run: |
          echo "${{ secrets.SERVER_SSH_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          ssh -o StrictHostKeyChecking=no -i /tmp/ssh_key -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
            cd /mnt/user/appdata/notes-app/repo &&
            git pull origin main &&
            cp -r backend/cmd backend/internal backend/pkg backend/go.mod backend/Dockerfile /mnt/user/appdata/notes-app/backend/ &&
            cd /mnt/user/appdata/notes-app/backend &&
            docker compose build &&
            docker compose up -d &&
            sleep 5 &&
            docker ps | grep notes-api
          '
          rm /tmp/ssh_key
