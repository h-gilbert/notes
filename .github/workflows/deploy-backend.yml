name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script_stop: true
          script: |
            cd /mnt/user/appdata/notes-app/repo
            git pull origin main

            # Copy updated backend files
            cp -r backend/cmd backend/internal backend/pkg backend/go.mod backend/Dockerfile /mnt/user/appdata/notes-app/backend/

            # Rebuild and restart
            cd /mnt/user/appdata/notes-app/backend
            docker compose build
            docker compose up -d

            # Verify deployment
            sleep 5
            docker ps | grep notes-api
            exit 0
